# ずんだもんBot 仕様書

## 目的
- 東北弁で可愛く答えるAIチャットBotとして、Discordでログを要約し、ユーザーと対話する。ボイスロイド「ずんだもん」（東北地方のキャラクター）を基にしたニッチなターゲットに特化し、ファン層や地域コミュニティとのエンゲージメントを高める。

## 機能
### 1. ログ管理と要約
- **実装内容**:
  - チャットログを`all_logs.txt`に保存し、20KBごとにDeepSeek R1で要約（`manage_summary`関数）。
  - レート制限（トークン使用量7,500トークン/日超過時）に備え、10KBごとにMixtral 8x7Bで仮要約（`manage_temporary_summary`関数）。
  - ログ要約は、`latest_summary.txt`と`temporary_summary.txt`に保存し、過去の会話文脈を保持。
- **工夫した点**:
  - ログサイズを20KB/10KBに制限し、Replit無料枠（512MB RAM）のメモリ制約に対応。
  - 要約生成時に東北弁のトーン（「ぼく、ずんだもんとして…」）を維持するプロンプトを設計し、キャラクターの一貫性を保つ。
  - トークン使用量を`used_tokens`で追跡し、DeepSeek R1の制限を超えないようにリアルタイム管理。

### 2. 応答生成
- **実装内容**:
  - ユーザー質問に東北弁で回答（`get_response`関数）。
  - DeepSeek R1（通常時）またはMixtral 8x7B（レート制限時）を使用し、`max_tokens=1`（最終回答）または`max_tokens=50`（長めの応答）で生成。
  - プロンプト（`zunda_prompt`）で「一人称「ぼく」、語尾「～のだ」「～なのだ」、敬語非使用」を強制。
- **工夫した点**:
  - 東北弁のトーンを維持するため、プロンプトに詳細な指示（「可愛く、元気いっぱいで、楽しく明るく」）を組み込み、モデルが意図通りに生成するよう設計。
  - トークン制限を考慮し、短い応答（`max_tokens=1`）でキャラクター性を保ちつつ、必要に応じて長めの応答（`max_tokens=50`）に拡張可能。
  - レート制限時のフォールバック（Mixtral 8x7B）を導入し、安定性とコスト効率を両立。

### 3. 同時処理抑制
- **実装内容**:
  - `asyncio.Queue(maxsize=3)`を使用して、同時リクエストを3件に制限（`on_message`関数）。
  - Discordのレート制限（50リクエスト/秒、10,000リクエスト/10分）に対応し、`safe_send`で1秒/30秒待機を自動管理。
- **工夫した点**:
  - Replit無料枠のCPU負荷を軽減し、安定動作を確保。
  - 1秒/1分ごとの送信回数（`send_count`）を追跡し、レート制限を回避するアルゴリズムを設計。
  - ユーザーに「多忙すぎちゃったのだ…」と通知し、親しみやすさとエラー処理の透明性を両立。

### 4. 通知オプション
- **実装内容**:
  - `!zunda notify on/off`コマンドで通知を切り替え可能（デフォルトオン、`bot.notify_enabled`フラグ）。
  - ログ整理やエラー時（`manage_summary`、`manage_temporary_summary`）に東北弁の通知メッセージを表示。
- **工夫した点**:
  - ユーザーが通知をオフにできる柔軟性を提供し、サーバー負荷を軽減。
  - 東北弁のメッセージ（「記憶を整理してるのだ…」）で、ずんだもんのキャラクターを維持しつつ、ユーザーに親しみやすさを提供。

### 5. フィードバックと学習機能（オプション）
- **実装内容**:
  - `!zunda feedback 良い/悪い [コメント]`でユーザーのフィードバックを収集（`feedback_logs.txt`保存）。
  - フィードバックを基にプロンプトやログを動的に調整（`adjust_prompt_based_on_feedback`関数、1日1回実行）。
- **工夫した点**:
  - DeepSeek R1のトークン制限（7,500トークン/日）を考慮し、フィードバック解析を最小限のトークンで実施。
  - コミュニティの声を反映し、ずんだもんのキャラクターや応答精度を向上させる学習機能を導入。

## 技術要件
- **環境**:
  - Replit無料枠（CPU、512MB RAM）で動作可能。
  - Python 3.x（`discord.py`, `openrouter`, `transformers`, `tiktoken`, `bitsandbytes`を使用）。
- **モデル**:
  - DeepSeek R1（クラウドAPI、7,500トークン/日無料制限）。
  - Mixtral 8x7B（8-bit量子化、ローカル実行、軽量要約用）。
- **依存ライブラリ**:
  - `discord.py`（Discord Botフレームワーク）。
  - `openrouter`（DeepSeek R1 APIアクセス）。
  - `transformers`（Mixtral 8x7Bロード）。
  - `tiktoken`（トークンカウント）。
  - `bitsandbytes`（Mixtral 8x7Bの8-bit量子化）。
- **設定**:
  - 環境変数（`TOKEN`, `CHANNEL_ID`, `DEEPSEEK_API_KEY`）をReplit Secretsで管理。

## 制約
- **トークン制限**:
  - DeepSeek R1の7,500トークン/日制限により、活発な使用でレート制限が発生（24時間待機が必要）。
- **リソース制約**:
  - Replit無料枠のメモリ（512MB）やCPU性能により、大量の同時リクエストや長文ログ処理が遅延する可能性。
- **API依存**:
  - DeepSeek R1の安定性やレスポンス速度に依存し、API障害やタイムアウト（60秒）が発生するリスク。
- **Discordレート制限**:
  - 50リクエスト/秒、10,000リクエスト/10分の制限に対応するため、1秒/30秒待機を導入。

## 工夫した点の概要
- **キャラクターの一貫性**:
  - 東北弁とずんだもんのトーン（「ぼく」「～のだ」「～なのだ」）をプロンプトで厳密に定義し、モデル生成の精度を高める。
- **コストとリソースの最適化**:
  - 無料API（DeepSeek R1）と軽量モデル（Mixtral 8x7B）を組み合わせ、Replit無料枠で動作可能に。
- **ユーザー体験の向上**:
  - 通知のカスタマイズ、フィードバック機能、親しみやすいエラーメッセージで、コミュニティエンゲージメントを強化。
- **スケーラビリティ**:
  - ログ管理、同時処理抑制、トークン管理で、負荷が増えても安定動作を確保。

## ライセンス
MITライセンス（変更可能）。

## 参考資料
- DeepSeek R1 APIドキュメント（[https://deepseek.com/docs](https://deepseek.com/docs)）。
- Discord.pyドキュメント（[https://discordpy.readthedocs.io](https://discordpy.readthedocs.io)）。
- Transformersライブラリ（[https://huggingface.co/docs/transformers](https://huggingface.co/docs/transformers)）。
